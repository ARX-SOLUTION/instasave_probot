name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'
  # ‚Üì‚Üì‚Üì HAR YANGI LOYIHADA FAQAT SHULARNI O'ZGARTIRING ‚Üì‚Üì‚Üì
  PROJECT_NAME: instasave_probot

jobs:
  lint:
    name: üîç Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - run: pnpm lint

  deploy:
    name: üöÄ Restart Application
    runs-on: ubuntu-latest
    needs: [lint]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: üîë Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

      - name: üìã Add known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: üöÄ Deploy Application with PM2
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          PROJECT_NAME: ${{ env.PROJECT_NAME }}
          REPO_URL: https://github.com/${{ github.repository }}.git
          DEPLOY_BRANCH: main
        run: |
          ssh "${SERVER_USER}@${SERVER_HOST}" \
            "PROJECT_NAME='${PROJECT_NAME}' REPO_URL='${REPO_URL}' DEPLOY_BRANCH='${DEPLOY_BRANCH}' bash -s" << 'ENDSSH'
            set -euo pipefail

            APP_DIR="$HOME/projects/${PROJECT_NAME}"

            echo "üìÇ Ensuring project directory exists..."
            mkdir -p "$HOME/projects"

            if [ ! -d "$APP_DIR/.git" ]; then
              echo "üì• Cloning repository into $APP_DIR ..."
              rm -rf "$APP_DIR"
              git clone "$REPO_URL" "$APP_DIR"
            fi

            echo "üîÑ Syncing latest code..."
            cd "$APP_DIR"
            git remote set-url origin "$REPO_URL"
            git fetch origin "$DEPLOY_BRANCH"
            git checkout "$DEPLOY_BRANCH"
            git pull --ff-only origin "$DEPLOY_BRANCH"

            if ! command -v pnpm >/dev/null 2>&1; then
              echo "üì¶ pnpm not found. Enabling via corepack..."
              corepack enable
              corepack prepare pnpm@9 --activate
            fi

            echo "üì¶ Installing dependencies..."
            pnpm install --frozen-lockfile

            echo "üèó Building the application..."
            pnpm build

            if [ -f "drizzle.config.ts" ]; then
              echo "üóÑ Running database migrations..."
              pnpm db:migrate
            fi

            echo "üîÑ Restarting processes with PM2..."
            mkdir -p logs
            if pm2 describe instasave-api >/dev/null 2>&1; then
              pm2 reload ecosystem.config.cjs --env production
            else
              pm2 start ecosystem.config.cjs --env production
            fi
            pm2 save

            echo "‚úÖ Deployment completed successfully."
          ENDSSH

      - name: üì¢ Telegram notification
        if: always()
        env:
          PROD_BOT_TOKEN: ${{ secrets.PROD_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_THREAD_ID: ${{ secrets.TELEGRAM_THREAD_ID }}
        run: |
          STATUS="${{ job.status == 'success' && '‚úÖ Success' || '‚ùå Failed' }}"
          MESSAGE="üöÄ *${{ env.PROJECT_NAME }} Deployment*

          üì¶ Repository: \`${{ github.repository }}\`
          üåø Branch: \`${{ github.ref_name }}\`
          üîó Commit: \`${GITHUB_SHA::7}\`
          üë§ Actor: \`${{ github.actor }}\`
          üìä Status: ${STATUS}

          [View Workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

          curl -s -X POST "https://api.telegram.org/bot${PROD_BOT_TOKEN}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{
              \"chat_id\": \"${TELEGRAM_CHAT_ID}\",
              \"message_thread_id\": ${TELEGRAM_THREAD_ID},
              \"text\": \"$MESSAGE\",
              \"parse_mode\": \"Markdown\",
              \"disable_web_page_preview\": true
            }"
